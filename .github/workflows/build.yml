name: Build Android APK - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± v2.1

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
      
      - name: ðŸ“Š Flutter version & info
        run: |
          flutter --version
          flutter doctor -v
      
      - name: ðŸ”§ Create local.properties
        run: |
          cd android
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "flutter.sdk=$FLUTTER_ROOT" >> local.properties
          echo "flutter.versionCode=1" >> local.properties
          echo "flutter.versionName=2.1.0" >> local.properties
          cat local.properties
      
      - name: ðŸ“¦ Get dependencies
        run: flutter pub get
      
      - name: ðŸ” Analyze code
        run: flutter analyze
        continue-on-error: true
      
      - name: âœ… Run tests
        run: flutter test
        continue-on-error: true
      
      - name: ðŸ—ï¸ Build APK (Release)
        run: flutter build apk --release --no-tree-shake-icons
      
      - name: ðŸ“‹ List build outputs
        run: |
          echo "=== Build Outputs ==="
          ls -lah build/app/outputs/flutter-apk/ || echo "APK directory not found"
          echo "=== APK Details ==="
          du -h build/app/outputs/flutter-apk/*.apk || echo "No APK files found"
      
      - name: ðŸ“± Rename APK with version
        run: |
          cd build/app/outputs/flutter-apk/
          VERSION="2.1.0"
          DATE=$(date +%Y%m%d)
          mv app-release.apk jabalia-attendance-v${VERSION}-${DATE}.apk
          ls -lah
      
      - name: â¬†ï¸ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: jabalia-attendance-apk-v2.1
          path: build/app/outputs/flutter-apk/jabalia-attendance-*.apk
          retention-days: 90
          if-no-files-found: error
      
      - name: ðŸ“ Generate build summary
        run: |
          echo "## ðŸŽ‰ Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± App Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: 2.1.0" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ APK Info" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh build/app/outputs/flutter-apk/*.apk >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ What's New in v2.1" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ Service Worker" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ø¯Ø¹Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù† Ø£ÙƒØ«Ø± Ù…Ù† Ø¬Ù‡Ø§Ø²" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù‘Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø² (Device ID)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Background Sync API" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­Ø³Ù‘Ù†Ø©" >> $GITHUB_STEP_SUMMARY
